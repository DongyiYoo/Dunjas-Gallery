<!DOCTYPE html>
<html>
<head>
    <title>Dunja Gallery</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f9f9f9; }
        
        .artwork { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 8px; 
            background: white; 
            max-width: 500px;
        }

        .artwork img { max-width: 100%; border-radius: 5px; margin-bottom: 10px; }
        .delete-btn { padding: 5px 15px; cursor: pointer; background-color: #ff0000; color: white; border: none; }
    </style>
</head>
<body>
    <h1>
    <a href="/" style="text-decoration: none;">
        Dunja Gallery
    </a>
</h1>
    <!-- show different message by the username -->
    <% if (user) { %>
        <p>Welcom to my Gallery, <b><%= user.username %></b>. (<a href="/logout">Logout</a>)</p>
    <% } else { %>
        <p><a href="/login">Login</a></p>
    <% } %>

    <hr>
    <!-- search bar -->
    <form action="/" method="GET">
        <input type="text" name="search" placeholder="Search here..." value="<%- search || '' %>">
        <button type="submit">Search</button>
    </form>
    
<% if (search) { %>
    <h3>Result: <%= search %></h3>
    <% if (artworks.length === 0) { %>
        <p>No artwork found for "<%= search %>".</p>
    <% } %>
<% } %>

    <hr>

    <h2>Gallery</h2>


    <!-- category navigation *DOM based XSS* -->
    <p>Choose a category:</p>
    <div class="categories">
        <a href="#Oil_Painting">Oil Painting</a> |
        <a href="#Arcrylic_Painting">Arcrylic Painting</a> |
        <a href="#Gouche">Gouche</a>
    </div>

    <div id="category" style="margin-top: 10px; color: black;"></div>

    <!-- display artworks -->
    <% artworks.forEach(function(art) { %>
        <div class="artwork">
            <h3><%= art.title %></h3>
            
            <% if (art.image_url) { %>
                <img src="<%= art.image_url %>" alt="Art Image"><br>
            <% } %>
            
            <p>Description: <%- art.description %></p>

            <form action="/delete" method="POST" style="margin-top:10px;">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">  <!-- add token -->
                <input type="hidden" name="id" value="<%= art.id %>">
                <button type="submit" class="delete-btn">Delete</button>
            </form>
        </div>
    <% }); %>

    <hr>

    <!-- add new artworks -->
    <h3>Add an artwork</h3>
    <form action="/add" method="POST" style="background:#eee; padding:15px; border-radius:5px;">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <input type="text" name="title" placeholder="Art Title" required><br><br>
        <input type="text" name="image_url" placeholder="Image URL (http://...)" style="width:100%;"><br><br>
        <input type="text" name="description" placeholder="description" required><br><br>
        <button type="submit">Add</button>
    </form>

    <hr>

    <hr>
    
    <script>
        function showCategory() {
            if (window.location.hash) {
                var category = decodeURIComponent(window.location.hash.substring(1));

                // defence DOM based XSS by using innerText
                document.getElementById("category").innerText = "Selected Category: " + category;
            }
        }

        // page load and hash changes to trigger the function
        window.addEventListener('load', showCategory);
        window.addEventListener('hashchange', showCategory);
    </script>

</body>
</html>